name: Release
on:
  release:
    types: [published]
env:
  CARGO_TERM_COLOR: always
permissions:
  contents: write
jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85"
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2
      - uses: extractions/setup-just@v2
      - run: just validate-version ${{ github.event.release.tag_name }}
      - run: just fmt-check
      - run: just check

  build-artifacts:
    name: Build Artifacts
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85"
          targets: x86_64-unknown-linux-musl
      - uses: Swatinem/rust-cache@v2
      - uses: extractions/setup-just@v2
      - name: Install musl tools
        run: sudo apt-get update && sudo apt-get install -y musl-tools
      - run: just build-release
      - run: just package ${{ github.event.release.tag_name }}
      - uses: actions/upload-artifact@v4
        with:
          name: release-tarball
          path: "*.tar.gz"

  publish-crate:
    name: Publish to crates.io
    needs: validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: "1.85"
      - uses: Swatinem/rust-cache@v2
      - uses: extractions/setup-just@v2
      - run: just publish
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  upload-artifacts:
    name: Upload Release Assets
    needs: build-artifacts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: release-tarball
      - name: Upload to GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
          GH_REPO: ${{ github.repository }}
        run: gh release upload ${{ github.event.release.tag_name }} *.tar.gz
